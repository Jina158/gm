<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fanruan.platform.mapper.UsersMapper">

    <resultMap id="getSubUserListResultMap" type="com.fanruan.platform.bean.User">
        <result column="username" jdbcType="VARCHAR" property="username" />
        <result column="password" jdbcType="VARCHAR" property="password" />
        <result column="mobile" jdbcType="VARCHAR" property="mobile" />
        <result column="email" jdbcType="VARCHAR" property="email" />
        <result column="companyName" jdbcType="VARCHAR" property="companyName" />
        <result column="deptName" jdbcType="VARCHAR" property="deptName" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="companyCode" jdbcType="VARCHAR" property="companyCode" />
        <result column="deptCode" jdbcType="VARCHAR" property="deptCode" />
        <result column="status" jdbcType="VARCHAR" property="status" />
        <result column="newcompanyFlag" jdbcType="VARCHAR" property="newcompanyFlag" />
        <result column="permissionRoles" jdbcType="VARCHAR" property="permissionRoles" />
    </resultMap>

    <select id="getSubUserList" resultType="com.fanruan.platform.bean.User">
        with ds1 as(
        SELECT CODE,NAME,SCODE,SNAME FROM BIUSER.ODS_HR_ORG
        UNION
        SELECT CODE,NAME,SCODE,SNAME FROM BIUSER.INPUT_HR_ORG
        )
        SELECT M.* FROM (
        SELECT ROWNUM AS rowno,N.*
        FROM (
        SELECT
        t.user_id as userId,
        t.username as username,
        t.password as password,
        t.mobile as mobile,
        t.email as email,
        t.company_name as companyName,
        t.dept_name as deptName,
        t.name as name,
        t.company_code as companyCode,
        t.dept_code as deptCode,
        t.status as status,
        t.newcompany_flag as newcompanyFlag,
        F_GET_PERMISSION_BY_USERID(t.user_id) as permissionRoles,
        CASE
        WHEN INSTR(F_GET_PERMISSION_BY_USERID(t.user_id),('sub_admin')) &gt; 0 THEN
        1
        ELSE
        0
        END as isSubAdmin
        FROM CREDIT_USER T
        WHERE username &lt;&gt; '80015868'
        AND company_code in (
        SELECT CODE --自身
        FROM BIUSER.ODS_HR_ORG A
        WHERE  CODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT CODE --下级公司
        FROM ds1 A
        WHERE SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT B.CODE --下下级公司
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT C.CODE --下下下级公司
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG C ON B.CODE=C.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT D.CODE --下下下下级公司
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG C ON B.CODE=C.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG D ON C.CODE=D.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        )
        <if test="name != null and name!=''">
            and (t.name like '%'||#{name}||'%' )
        </if>
        <if test="username != null and username!=''">
        and (t.username like '%'||#{username}||'%' )
        </if>
            <if test="status != null">
            and (t.status = #{status} )
        </if>
        ORDER BY isSubAdmin DESC,status desc
        ) N
        WHERE 1=1
        <if test="isSubAdmin != null">
            and (N.isSubAdmin = #{isSubAdmin} )
        </if>
        ) M
        WHERE 1=1
        <if test="isSubAdmin != null">
            and (M.isSubAdmin = #{isSubAdmin} )
        </if>
        AND rowno &lt;= #{pageIndex} * #{pageSize}
        AND rowno &gt; (#{pageIndex}-1) * #{pageSize}
</select>

    <resultMap id="getSubUserListCountResultMap" type="java.lang.Integer">
        <result column="co" jdbcType="VARCHAR" property="co" />
    </resultMap>

    <select id="getSubUserListCount" resultType="java.lang.Integer">
        with ds1 as(
        SELECT CODE,NAME,SCODE,SNAME FROM BIUSER.ODS_HR_ORG
        UNION
        SELECT CODE,NAME,SCODE,SNAME FROM BIUSER.INPUT_HR_ORG
        )
        SELECT COUNT(*) as co FROM (
        SELECT
        ROWNUM AS rowno,
        t.user_id as userId,
        t.username as username,
        t.password as password,
        t.mobile as mobile,
        t.email as email,
        t.company_name as companyName,
        t.dept_name as deptName,
        t.name as name,
        t.company_code as companyCode,
        t.dept_code as deptCode,
        t.status as status,
        t.newcompany_flag as newcompanyFlag,
        F_GET_PERMISSION_BY_USERID(t.user_id) as permissionRoles,
        CASE
        WHEN INSTR(F_GET_PERMISSION_BY_USERID(t.user_id),('sub_admin')) &gt; 0 THEN
        1
        ELSE
        0
        END as isSubAdmin
        FROM CREDIT_USER T
        WHERE username &lt;&gt; 'admin'
        AND company_code in (
        SELECT CODE
        FROM ds1 A
        WHERE  CODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT CODE
        FROM ds1 A
        WHERE SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT B.CODE
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT C.CODE
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG C ON B.CODE=C.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        UNION ALL
        SELECT D.CODE
        FROM ds1 A
        INNER JOIN BIUSER.ODS_HR_ORG B ON A.CODE=B.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG C ON B.CODE=C.SCODE
        INNER JOIN BIUSER.ODS_HR_ORG D ON C.CODE=D.SCODE
        WHERE A.SCODE=(SELECT COMPANY_CODE FROM CREDIT_USER WHERE USERNAME=#{operator})
        )
        <if test="name != null and name!=''">
            and (t.name like '%'||#{name}||'%' )
        </if>
        <if test="username != null and username!=''">
            and (t.username like '%'||#{username}||'%' )
        </if>
        <if test="status != null">
            and (t.status = #{status} )
        </if>
        ) M
        WHERE 1=1
        <if test="isSubAdmin != null">
            and (M.isSubAdmin = #{isSubAdmin} )
        </if>
    </select>

</mapper>

